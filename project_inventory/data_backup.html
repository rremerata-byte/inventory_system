<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Data Backup - Rainbow Direct Selling</title>
<style>
  body {
    margin: 0;
    font-family: "Poppins", sans-serif;
    background: url('rainbow.png') no-repeat center;
    background-size: cover;
    background-attachment: fixed;
    user-select: none;
  }
  /* Rainbow Header */
  header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
      color: white;
      padding: 10px 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }
  header img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-right: 10px;
  }
  nav a {
      text-decoration: none;
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: 500;
      transition: background 0.3s;
  }
  nav a:hover, nav a.active {
      background: rgba(255, 255, 255, 0.3);
  }
  main.container {
    max-width: 560px;
    margin: 42px auto 60px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 30px;
    padding: 30px 36px 40px;
    box-sizing: border-box;
    box-shadow:
      0 0 60px rgba(255, 127, 0, 0.1),
      0 0 90px rgba(75, 0, 130, 0.1);
  }
  main h1 {
    font-weight: 700;
    margin-bottom: 6px;
    user-select:none;
  }
  main p.subtext {
    margin: 0 0 20px 0;
    font-weight: 500;
    color: #444;
    user-select:none;
  }
  section.backup-status {
    background: linear-gradient(45deg, #f07a27, #e468f9);
    border-radius: 18px;
    padding: 18px 24px;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    box-shadow: 0 4px 20px rgba(255, 105, 110, 0.5);
    margin-bottom: 28px;
    user-select:none;
  }
  section.backup-status p {
    margin: 0 0 6px 0;
  }
  section.backup-status small {
    font-weight: 400;
    font-size: 0.9rem;
    opacity: 0.8;
  }
  section.export-section {
    background: #f9f8e1;
    padding: 22px 24px;
    border-radius: 18px;
    margin-bottom: 28px;
    box-shadow: inset 0 0 12px rgba(0,0,0,0.05);
    user-select: none;
  }
  section.export-section p {
    margin: 0 0 10px 0;
    font-weight: 600;
  }
  button.export-btn {
    background-color: #7b75ff;
    color: white;
    font-weight: 700;
    font-size: 1rem;
    border: none;
    padding: 10px 30px;
    margin-right: 14px;
    border-radius: 9px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select:none;
  }
  button.export-btn:hover {
    background-color: #5a53d3;
  }
  button#autoBackupBtn {
    background: #f0f0d0;
    font-weight: 700;
    border: none;
    padding: 14px 30px;
    border-radius: 19px;
    color: #222;
    cursor: pointer;
    user-select:none;
    transition: background-color 0.3s ease;
  }
  button#autoBackupBtn:hover {
    background-color: #dadab5;
  }
</style>
</head>
<body>

<header>
    <div class="logo-title">
        <img src="rainbow.png" alt="Rainbow Logo" />
    </div>
    <nav>
        <a href="dashboard.html">Dashboard</a>
        <a href="productlisting.html">Product Listing</a>
        <a href="stock_add.html">Stock Add</a>
        <a href="stock_sold.html">Stock Sold</a>
        <a href="daily_sales_report.html">Daily Sales Report</a>
        <a href="settings.html" class="active" style="color: white; text-decoration:none; padding: 8px 15px; border-radius: 8px; background: rgba(128,128,255,0.6); filter: drop-shadow(0 0 6px #888); cursor: default;">Settings</a>
    </nav>
</header>

<main class="container" role="main" aria-label="Data Backup and Restore">
  <a href="settings.html" style="color:#4caf50; text-decoration:none; display:inline-block; margin-bottom:20px; user-select:none;">‚Üê Back to Settings Overview</a>
  
  <h1>Data Backup</h1>
  <p class="subtext">Manage export and import of inventory data</p>

  <h2>Data Backup and Restore</h2>

  <section class="backup-status" aria-live="polite" aria-atomic="true" role="region">
    <p>Database successfully backed up on: <span id="backupDate">Never</span></p>
    <small id="backupSize">Size: N/A</small>
  </section>

  <section class="export-section" aria-label="Export and Download Data">
    <p>Create a local copy of your entire inventory and sales history.</p>
    <button class="export-btn" id="downloadCsvBtn" aria-label="Download as CSV">Download as CSV</button>
    <button class="export-btn" id="downloadPdfBtn" aria-label="Download as PDF">Download as PDF</button>
  </section>

  <button id="autoBackupBtn" aria-label="Manage Auto-Backup Settings">Manage Auto-Backup Settings</button>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const { jsPDF } = window.jspdf;

  const backupDateElem = document.getElementById('backupDate');
  const backupSizeElem = document.getElementById('backupSize');

  // Update backup info from localStorage
  function updateBackupInfo() {
    const lastBackupTimestamp = localStorage.getItem('lastBackupTimestamp');
    const backupSize = localStorage.getItem('backupSize');
    if (lastBackupTimestamp) {
      const d = new Date(lastBackupTimestamp);
      backupDateElem.textContent = d.toLocaleDateString() + ' at ' + d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    } else {
      backupDateElem.textContent = 'Never';
    }
    backupSizeElem.textContent = backupSize ? `Size: ${backupSize}` : 'Size: N/A';
  }

  function convertProductsAndSalesToCSV() {
    const products = JSON.parse(localStorage.getItem('rainbow_products') || '[]');
    const sales = JSON.parse(localStorage.getItem('rainbow_sales') || '[]');

    let csv = 'Type,Product Name,Category,Price,Quantity,Min Stock,Date,Sale Quantity,Unit Cost,Sale Price\n';

    products.forEach(p => {
      csv += `Product,"${p.name}","${p.category}",${p.price},${p.stock},${p.minStock},,,,\n`;
    });

    sales.forEach(s => {
      csv += `Sale,"${s.productName}","${s.category}",,,,,${s.date},${s.quantitySold},${s.unitCost},${s.salePrice}\n`;
    });

    return csv;
  }

  document.getElementById('downloadCsvBtn').addEventListener('click', () => {
    try {
      const csv = convertProductsAndSalesToCSV();
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'rainbow_inventory_sales_backup.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      const now = new Date();
      localStorage.setItem('lastBackupTimestamp', now.toISOString());
      localStorage.setItem('backupSize', (blob.size / 1024).toFixed(2) + ' KB');
      updateBackupInfo();
    } catch(err) {
      alert('Error generating CSV: ' + err.message);
    }
  });

  document.getElementById('downloadPdfBtn').addEventListener('click', () => {
    try {
      const products = JSON.parse(localStorage.getItem('rainbow_products') || '[]');
      const sales = JSON.parse(localStorage.getItem('rainbow_sales') || '[]');

      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text("Rainbow Direct Selling Inventory Backup", 14, 22);

      doc.setFontSize(12);
      doc.text(`Backup Date: ${new Date().toLocaleString()}`, 14, 30);

      let y = 40;

      doc.setFontSize(14);
      doc.text("Products:", 14, y);
      y += 8;
      doc.setFontSize(10);
      doc.text("Name", 14, y);
      doc.text("Category", 70, y);
      doc.text("Price", 120, y);
      doc.text("Stock", 150, y);
      doc.text("Min Stock", 180, y);
      y += 6;
      doc.line(14, y, 196, y);
      y += 6;

      products.forEach(p => {
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
        doc.text(p.name, 14, y);
        doc.text(p.category, 70, y);
        doc.text(String(p.price), 120, y);
        doc.text(String(p.stock), 150, y);
        doc.text(String(p.minStock), 180, y);
        y += 8;
      });

      y += 10;
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
      doc.setFontSize(14);
      doc.text("Sales:", 14, y);
      y += 8;
      doc.setFontSize(10);
      doc.text("Product", 14, y);
      doc.text("Category", 70, y);
      doc.text("Date", 120, y);
      doc.text("Qty Sold", 150, y);
      doc.text("Unit Cost", 180, y);
      doc.text("Sale Price", 210, y);
      y += 6;
      doc.line(14, y, 196, y);
      y += 6;

      sales.forEach(s => {
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
        doc.text(s.productName, 14, y);
        doc.text(s.category, 70, y);
        doc.text(new Date(s.date).toLocaleDateString(), 120, y);
        doc.text(String(s.quantitySold), 150, y);
        doc.text(s.unitCost.toFixed(2), 180, y);
        doc.text(s.salePrice.toFixed(2), 210, y);
        y += 8;
      });

      doc.save("rainbow_inventory_sales_backup.pdf");

      const now = new Date();
      localStorage.setItem('lastBackupTimestamp', now.toISOString());
      localStorage.setItem('backupSize', 'PDF Generated');
      updateBackupInfo();
    } catch(err) {
      alert('Error generating PDF: ' + err.message);
    }
  });

  document.getElementById('autoBackupBtn').addEventListener('click', () => {
    alert('Auto-backup settings feature coming soon.');
  });

  function updateBackupInfo() {
    const lastBackupTimestamp = localStorage.getItem('lastBackupTimestamp');
    const backupSize = localStorage.getItem('backupSize');
    if (lastBackupTimestamp) {
      const d = new Date(lastBackupTimestamp);
      backupDateElem.textContent = d.toLocaleDateString() + ' at ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } else {
      backupDateElem.textContent = 'Never';
    }
    backupSizeElem.textContent = backupSize ? `Size: ${backupSize}` : 'Size: N/A';
  }

  window.onload = updateBackupInfo;
</script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</body>
</html>
